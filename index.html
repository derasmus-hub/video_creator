<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Video Renderer ‚Äî Control Room</title>
  <style>
    :root{
      --card-bg: rgba(10, 18, 32, 0.70);
      --card-border: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --accent: rgba(99, 179, 237, 0.95);
      --danger: rgba(248, 113, 113, 0.95);
      --ok: rgba(74, 222, 128, 0.95);
      --shadow: 0 20px 60px rgba(0,0,0,0.35);
      --radius: 18px;
      --gap: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background:
        linear-gradient(180deg, rgba(7,12,22,0.55), rgba(7,12,22,0.75)),
        url("background.png") center/cover no-repeat fixed;
      overflow-x: hidden;
    }

    .wrap {
      max-width: 1120px;
      margin: 0 auto;
      padding: 32px 18px 60px;
    }

    header {
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 16px;
      margin-bottom: 18px;
    }

    h1 {
      margin: 0;
      font-size: clamp(22px, 3vw, 34px);
      letter-spacing: 0.4px;
    }

    .sub {
      margin: 6px 0 0;
      color: var(--muted);
      max-width: 72ch;
      line-height: 1.35;
      font-size: 14px;
    }

    .grid {
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 16px;
      align-items:start;
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
      header { align-items: flex-start; flex-direction: column; }
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 16px;
    }

    .row {
      display:flex;
      gap: var(--gap);
      flex-wrap: wrap;
    }

    label {
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input[type="text"], input[type="number"], input[type="url"], select, textarea {
      width: 100%;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 10px;
      outline: none;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="url"]:focus,
    select:focus,
    textarea:focus {
      border-color: rgba(99,179,237,0.65);
      box-shadow: 0 0 0 3px rgba(99,179,237,0.18);
    }

    .field { flex: 1; min-width: 220px; }
    .field.small { min-width: 160px; flex: 0.6; }
    .field.tiny  { min-width: 120px; flex: 0.4; }

    .slides {
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 12px;
    }

    .slide {
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      padding: 10px;
      background: rgba(255,255,255,0.05);
    }

    .slide-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .pill {
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 5px 10px;
      border-radius: 999px;
    }

    .btn {
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      user-select: none;
      font-weight: 600;
    }

    .btn:hover { background: rgba(255,255,255,0.12); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .btn.primary {
      background: rgba(99,179,237,0.22);
      border-color: rgba(99,179,237,0.45);
    }

    .btn.danger {
      background: rgba(248,113,113,0.16);
      border-color: rgba(248,113,113,0.45);
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .status {
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,0.78);
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 10px;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 140px;
    }

    .divider {
      height: 1px;
      background: rgba(255,255,255,0.10);
      margin: 14px 0;
    }

    /* Toggle rows */
    .toggle-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      border-radius: 14px;
      padding: 10px 12px;
      flex: 1;
      min-width: 220px;
    }
    .toggle-left { display:flex; flex-direction:column; gap: 2px; }
    .toggle-title { font-weight: 700; font-size: 13px; }
    .toggle-sub { font-size: 12px; color: rgba(255,255,255,0.70); line-height: 1.25; }

    .switch {
      position: relative;
      width: 46px;
      height: 28px;
      border-radius: 999px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.14);
      flex: 0 0 auto;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease;
    }
    .switch[data-on="true"] {
      background: rgba(74,222,128,0.22);
      border-color: rgba(74,222,128,0.40);
    }
    .knob {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(255,255,255,0.88);
      transition: transform .15s ease;
    }
    .switch[data-on="true"] .knob { transform: translateX(18px); }

    .inline-note {
      font-size: 12px;
      color: rgba(255,255,255,0.68);
      margin-top: 6px;
      line-height: 1.3;
    }

    .two-col {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px) {
      .two-col { grid-template-columns: 1fr; }
    }

    .small-code {
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,0.85);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Video Renderer ‚Äî Control Room</h1>
        <p class="sub">
          This UI now only shows inputs your <span class="pill">render_video.py</span> actually uses:
          JSON payload with <b>4‚Äì25 image URLs</b>, optional <b>audioUrl</b>, and supported <b>brand</b> toggles
          (<b>watermark/logo</b>, <b>intro/outro</b>, <b>cinematic effects</b>).<br />
          <span class="small-code">Frame overlay controls were removed</span> (because you asked to remove frames from rendering).
        </p>
      </div>
      <div class="pill">v4 UI (API-aligned)</div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="row">
          <div class="field">
            <label for="apiBase">API Base URL</label>
            <input id="apiBase" type="url" value="http://localhost:8000" />
            <div class="hint" style="margin-top:6px;">
              Example: <span class="pill">http://localhost:8000</span> or your deployed domain.
            </div>
          </div>

          <div class="field">
            <label for="apiPath">Render endpoint path</label>
            <input id="apiPath" type="text" value="/render" />
            <div class="hint" style="margin-top:6px;">
              Set this to your FastAPI route that returns <span class="pill">video/mp4</span>.
              (Common examples: <span class="pill">/render</span>, <span class="pill">/render-video</span>, <span class="pill">/video/render</span>)
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="field small">
            <label for="format">Format</label>
            <select id="format">
              <option value="reel">reel (1080√ó1920)</option>
              <option value="square">square (1080√ó1080)</option>
              <option value="linkedin">linkedin (1080√ó1350)</option>
            </select>
          </div>

          <div class="field small">
            <label for="style">Style</label>
            <select id="style">
              <option value="dark_lab">dark_lab</option>
              <option value="clean_medical">clean_medical</option>
              <option value="energetic">energetic</option>
            </select>
          </div>

          <div class="field small">
            <label for="transition">Transition</label>
            <select id="transition">
              <option value="fade">fade</option>
              <option value="wipeleft">wipeleft</option>
              <option value="wiperight">wiperight</option>
              <option value="slideleft">slideleft</option>
              <option value="slideright">slideright</option>
            </select>
          </div>

          <div class="field tiny">
            <label for="fps">FPS (1‚Äì60)</label>
            <input id="fps" type="number" min="1" max="60" value="30" />
          </div>

          <div class="field tiny">
            <label for="durationSec">Duration (sec ‚â• 2)</label>
            <input id="durationSec" type="number" min="2" value="12" />
          </div>

          <div class="field tiny">
            <label for="audioVolume">Audio Volume (0..3)</label>
            <input id="audioVolume" type="number" min="0" max="3" step="0.01" value="0.50" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="two-col">
          <div class="field">
            <label for="audioUrl">Audio URL (optional)</label>
            <input id="audioUrl" type="url" placeholder="https://.../audio.mp3" />
            <div class="inline-note">
              Your API can take <span class="pill">payload.audioUrl</span>. If empty, video renders with no audio (unless your server injects one).
            </div>
          </div>

          <div class="field">
            <label for="minSlideSec">Brand: minSlideSec (optional)</label>
            <input id="minSlideSec" type="number" min="0" step="0.1" value="2.8" />
            <div class="inline-note">
              Maps to <span class="pill">brand.minSlideSec</span> in your renderer.
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Branding toggles that match render_video.py -->
        <div class="row">
          <div class="toggle-row">
            <div class="toggle-left">
              <div class="toggle-title">Logo enabled</div>
              <div class="toggle-sub">Master switch: disables watermark + intro/outro logos</div>
            </div>
            <div id="toggleLogoEnabled" class="switch" data-on="true" role="switch" aria-checked="true" tabindex="0">
              <div class="knob"></div>
            </div>
          </div>

          <div class="toggle-row">
            <div class="toggle-left">
              <div class="toggle-title">Watermark</div>
              <div class="toggle-sub">Bottom corner logo overlay on slideshow</div>
            </div>
            <div id="toggleWatermark" class="switch" data-on="true" role="switch" aria-checked="true" tabindex="0">
              <div class="knob"></div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="toggle-row">
            <div class="toggle-left">
              <div class="toggle-title">Intro</div>
              <div class="toggle-sub">Colored intro card (optional centered logo)</div>
            </div>
            <div id="toggleIntro" class="switch" data-on="true" role="switch" aria-checked="true" tabindex="0">
              <div class="knob"></div>
            </div>
          </div>

          <div class="toggle-row">
            <div class="toggle-left">
              <div class="toggle-title">Outro</div>
              <div class="toggle-sub">Colored outro card (optional logo + outroText)</div>
            </div>
            <div id="toggleOutro" class="switch" data-on="true" role="switch" aria-checked="true" tabindex="0">
              <div class="knob"></div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="toggle-row">
            <div class="toggle-left">
              <div class="toggle-title">Cinematic effects</div>
              <div class="toggle-sub">Controls vignette + grain + breathing shadow + textures</div>
            </div>
            <div id="toggleCinematic" class="switch" data-on="true" role="switch" aria-checked="true" tabindex="0">
              <div class="knob"></div>
            </div>
          </div>

          <div class="toggle-row">
            <div class="toggle-left">
              <div class="toggle-title">Film grain</div>
              <div class="toggle-sub">Applies FFmpeg noise effect if enabled</div>
            </div>
            <div id="toggleFilmGrain" class="switch" data-on="true" role="switch" aria-checked="true" tabindex="0">
              <div class="knob"></div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="toggle-row">
            <div class="toggle-left">
              <div class="toggle-title">Vignette</div>
              <div class="toggle-sub">Applies vignette (amount if supported)</div>
            </div>
            <div id="toggleVignette" class="switch" data-on="true" role="switch" aria-checked="true" tabindex="0">
              <div class="knob"></div>
            </div>
          </div>

          <div class="toggle-row">
            <div class="toggle-left">
              <div class="toggle-title">Breathing shadow</div>
              <div class="toggle-sub">Subtle pulsating shadow (optional)</div>
            </div>
            <div id="toggleBreathingShadow" class="switch" data-on="false" role="switch" aria-checked="false" tabindex="0">
              <div class="knob"></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="field">
            <label for="logoUrl">Brand: logoUrl (optional)</label>
            <input id="logoUrl" type="url" placeholder="https://.../logo.png" />
            <div class="inline-note">
              If empty, your API may use bundled <span class="pill">/app/assets/logo.png</span> (if it exists).
            </div>
          </div>
        </div>

        <div class="two-col" style="margin-top:10px;">
          <div class="field">
            <label for="watermarkPos">Brand: watermarkPos</label>
            <select id="watermarkPos">
              <option value="br">br (bottom-right)</option>
              <option value="bl">bl (bottom-left)</option>
              <option value="tr">tr (top-right)</option>
              <option value="tl">tl (top-left)</option>
            </select>
          </div>

          <div class="field">
            <label for="watermarkOpacity">Brand: watermarkOpacity (0.05..1)</label>
            <input id="watermarkOpacity" type="number" min="0.05" max="1" step="0.01" value="1.00" />
          </div>

          <div class="field">
            <label for="watermarkSize">Brand: watermarkSize (px)</label>
            <input id="watermarkSize" type="number" min="40" step="1" value="260" />
          </div>
        </div>

        <div class="two-col" style="margin-top:10px;">
          <div class="field">
            <label for="introSec">Brand: introSec</label>
            <input id="introSec" type="number" min="0" step="0.1" value="0.6" />
          </div>
          <div class="field">
            <label for="outroSec">Brand: outroSec</label>
            <input id="outroSec" type="number" min="0" step="0.1" value="1.2" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label for="outroText">Brand: outroText (optional)</label>
            <input id="outroText" type="text" placeholder="Thanks for watching‚Ä¶" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between; align-items:center;">
          <div class="hint">Slides: <span id="slideCount" class="pill">0</span> (must be 4‚Äì25)</div>
          <div class="row">
            <button id="addSlide" class="btn" type="button">+ Add Slide</button>
            <button id="loadDemo" class="btn" type="button">Load Demo (4)</button>
            <button id="clearSlides" class="btn danger" type="button">Clear</button>
          </div>
        </div>

        <div class="slides" id="slides"></div>

        <div class="divider"></div>

        <div class="row">
          <button id="renderBtn" class="btn primary" type="button" style="flex:1;">Render Video</button>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h3 style="margin:0 0 8px;">Status</h3>
        <div id="status" class="status">Ready.</div>

        <div class="divider"></div>

        <h3 style="margin:0 0 8px;">Quick rules (API-aligned)</h3>
        <div class="hint">
          <ul style="margin:0; padding-left:18px; line-height:1.4;">
            <li>Slides must be <b>4‚Äì25</b></li>
            <li>Each slide needs an <b>imageUrl</b> (your API requires it)</li>
            <li>FPS must be <b>1‚Äì60</b></li>
            <li>Duration must be <b>‚â• 2</b></li>
            <li>Audio volume is clamped by API to <b>0..3</b></li>
            <li><b>Frame inputs removed</b> (UI will never send frame data)</li>
          </ul>
        </div>

        <div class="divider"></div>

        <h3 style="margin:0 0 8px;">Payload preview</h3>
        <div id="payloadPreview" class="status" style="min-height: 220px;">(will update as you edit)</div>
      </div>
    </div>
  </div>

<script>
  "use strict";

  const el = (id) => document.getElementById(id);

  const slidesEl = el("slides");
  const slideCountEl = el("slideCount");
  const statusEl = el("status");
  const renderBtn = el("renderBtn");
  const payloadPreviewEl = el("payloadPreview");

  function logStatus(msg) { statusEl.textContent = msg; }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll("\"","&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------- Switch helpers ----------
  function isSwitchOn(swEl) {
    return String(swEl.getAttribute("data-on")) === "true";
  }
  function setSwitch(swEl, on) {
    const v = !!on;
    swEl.setAttribute("data-on", v ? "true" : "false");
    swEl.setAttribute("aria-checked", v ? "true" : "false");
  }
  function toggleSwitch(swEl) {
    setSwitch(swEl, !isSwitchOn(swEl));
  }
  function wireSwitch(swEl, onChange) {
    swEl.addEventListener("click", () => {
      toggleSwitch(swEl);
      onChange && onChange(isSwitchOn(swEl));
    });
    swEl.addEventListener("keydown", (e) => {
      if (e.key === " " || e.key === "Enter") {
        e.preventDefault();
        toggleSwitch(swEl);
        onChange && onChange(isSwitchOn(swEl));
      }
    });
  }

  const toggleLogoEnabledEl = el("toggleLogoEnabled");
  const toggleWatermarkEl = el("toggleWatermark");
  const toggleIntroEl = el("toggleIntro");
  const toggleOutroEl = el("toggleOutro");
  const toggleCinematicEl = el("toggleCinematic");
  const toggleFilmGrainEl = el("toggleFilmGrain");
  const toggleVignetteEl = el("toggleVignette");
  const toggleBreathingShadowEl = el("toggleBreathingShadow");

  setSwitch(toggleLogoEnabledEl, true);
  setSwitch(toggleWatermarkEl, true);
  setSwitch(toggleIntroEl, true);
  setSwitch(toggleOutroEl, true);
  setSwitch(toggleCinematicEl, true);
  setSwitch(toggleFilmGrainEl, true);
  setSwitch(toggleVignetteEl, true);
  setSwitch(toggleBreathingShadowEl, false);

  wireSwitch(toggleLogoEnabledEl, () => { syncBrandFields(); refreshPreview(); });
  wireSwitch(toggleWatermarkEl, () => { syncBrandFields(); refreshPreview(); });
  wireSwitch(toggleIntroEl, () => { syncBrandFields(); refreshPreview(); });
  wireSwitch(toggleOutroEl, () => { syncBrandFields(); refreshPreview(); });
  wireSwitch(toggleCinematicEl, () => { syncBrandFields(); refreshPreview(); });
  wireSwitch(toggleFilmGrainEl, () => { syncBrandFields(); refreshPreview(); });
  wireSwitch(toggleVignetteEl, () => { syncBrandFields(); refreshPreview(); });
  wireSwitch(toggleBreathingShadowEl, () => { syncBrandFields(); refreshPreview(); });

  function syncBrandFields() {
    const logoEnabled = isSwitchOn(toggleLogoEnabledEl);
    const watermark = isSwitchOn(toggleWatermarkEl) && logoEnabled;

    el("logoUrl").disabled = !logoEnabled;
    el("watermarkPos").disabled = !watermark;
    el("watermarkOpacity").disabled = !watermark;
    el("watermarkSize").disabled = !watermark;

    const introOn = isSwitchOn(toggleIntroEl);
    const outroOn = isSwitchOn(toggleOutroEl);

    el("introSec").disabled = !introOn;
    el("outroSec").disabled = !outroOn;
    el("outroText").disabled = !outroOn;

    const cinematic = isSwitchOn(toggleCinematicEl);
    // These are still meaningful only if cinematic effects are on
    toggleFilmGrainEl.style.opacity = cinematic ? "1" : "0.6";
    toggleVignetteEl.style.opacity = cinematic ? "1" : "0.6";
    toggleBreathingShadowEl.style.opacity = cinematic ? "1" : "0.6";
  }

  function currentSlides() {
    const nodes = slidesEl.querySelectorAll(".slide");
    return [...nodes].map((node) => {
      const headline = node.querySelector(".headline").value.trim();
      const imageUrl = node.querySelector(".imageUrl").value.trim();
      return { imageUrl, headline: headline || null };
    });
  }

  function refreshSlideCount() {
    slideCountEl.textContent = String(slidesEl.querySelectorAll(".slide").length);
  }

  function relabelSlides() {
    [...slidesEl.querySelectorAll(".slide")].forEach((s, i) => {
      const pill = s.querySelector(".pill");
      if (pill) pill.textContent = `Slide ${i + 1}`;
    });
  }

  function buildPayload() {
    const logoEnabled = isSwitchOn(toggleLogoEnabledEl);
    const watermark = isSwitchOn(toggleWatermarkEl) && logoEnabled;

    const introOn = isSwitchOn(toggleIntroEl);
    const outroOn = isSwitchOn(toggleOutroEl);

    const cinematic = isSwitchOn(toggleCinematicEl);
    const filmGrain = isSwitchOn(toggleFilmGrainEl);
    const vignette = isSwitchOn(toggleVignetteEl);
    const breathingShadow = isSwitchOn(toggleBreathingShadowEl);

    const logoUrl = el("logoUrl").value.trim();
    const watermarkPos = el("watermarkPos").value;
    const watermarkOpacity = Number(el("watermarkOpacity").value);
    const watermarkSize = Number(el("watermarkSize").value);

    const introSec = Number(el("introSec").value);
    const outroSec = Number(el("outroSec").value);
    const outroText = el("outroText").value.trim();

    const minSlideSec = Number(el("minSlideSec").value);

    const payload = {
      format: el("format").value,
      style: el("style").value,
      transition: el("transition").value,
      durationSec: Number(el("durationSec").value),
      output: { fps: Number(el("fps").value) },
      audioVolume: Number(el("audioVolume").value),
      audioUrl: (el("audioUrl").value.trim() || null),
      slides: currentSlides().map(s => ({
        kind: "image",
        imageUrl: s.imageUrl,
        headline: s.headline
      })),
      brand: {
        // These names match your render_video.py expectations:
        logoEnabled: logoEnabled,
        watermark: watermark,
        watermarkPos: watermarkPos,
        watermarkOpacity: watermarkOpacity,
        watermarkSize: watermarkSize,

        intro: introOn,
        outro: outroOn,
        introSec: introSec,
        outroSec: outroSec,
        outroText: outroText || "",

        cinematicEffectsEnabled: cinematic,
        filmGrain: cinematic ? filmGrain : false,
        vignette: cinematic ? vignette : false,
        breathingShadow: cinematic ? breathingShadow : false,

        minSlideSec: Number.isFinite(minSlideSec) ? minSlideSec : 2.8,

        // Optional only if provided:
        ...(logoUrl ? { logoUrl: logoUrl } : {})
      }
    };

    // If no audioUrl, remove it so backend sees None / missing consistently
    if (!payload.audioUrl) delete payload.audioUrl;

    // If watermark is off, remove watermark tuning fields (cleaner payload)
    if (!payload.brand.watermark) {
      delete payload.brand.watermarkPos;
      delete payload.brand.watermarkOpacity;
      delete payload.brand.watermarkSize;
    }

    // If intro/outro off, remove their seconds/text to avoid confusion
    if (!payload.brand.intro) delete payload.brand.introSec;
    if (!payload.brand.outro) {
      delete payload.brand.outroSec;
      delete payload.brand.outroText;
    }

    return payload;
  }

  function validatePayload(payload) {
    if (!Array.isArray(payload.slides) || payload.slides.length < 4 || payload.slides.length > 25) {
      throw new Error(`Slides must be 4‚Äì25. You have ${payload.slides?.length ?? 0}.`);
    }
    for (let i = 0; i < payload.slides.length; i++) {
      const url = (payload.slides[i].imageUrl || "").trim();
      if (!url) throw new Error(`Slide ${i + 1} must have imageUrl (your API requires it).`);
      try { new URL(url); } catch { throw new Error(`Slide ${i + 1} imageUrl is not a valid URL.`); }
    }

    if (!Number.isFinite(payload.durationSec) || payload.durationSec < 2) throw new Error("Duration must be at least 2 seconds.");
    if (!Number.isFinite(payload.output?.fps) || payload.output.fps < 1 || payload.output.fps > 60) throw new Error("FPS must be 1‚Äì60.");
    if (!Number.isFinite(payload.audioVolume) || payload.audioVolume < 0 || payload.audioVolume > 3) throw new Error("Audio volume must be 0..3.");
    if (payload.audioUrl) {
      try { new URL(payload.audioUrl); } catch { throw new Error("audioUrl is not a valid URL."); }
    }

    const b = payload.brand || {};
    if (b.watermarkOpacity !== undefined && (!Number.isFinite(b.watermarkOpacity) || b.watermarkOpacity < 0.05 || b.watermarkOpacity > 1)) {
      throw new Error("Brand watermarkOpacity must be 0.05..1.");
    }
    if (b.watermarkSize !== undefined && (!Number.isFinite(b.watermarkSize) || b.watermarkSize < 40)) {
      throw new Error("Brand watermarkSize must be ‚â• 40.");
    }
    if (b.introSec !== undefined && (!Number.isFinite(b.introSec) || b.introSec < 0)) {
      throw new Error("Brand introSec must be ‚â• 0.");
    }
    if (b.outroSec !== undefined && (!Number.isFinite(b.outroSec) || b.outroSec < 0)) {
      throw new Error("Brand outroSec must be ‚â• 0.");
    }
    if (b.minSlideSec !== undefined && (!Number.isFinite(b.minSlideSec) || b.minSlideSec < 0)) {
      throw new Error("Brand minSlideSec must be ‚â• 0.");
    }
  }

  function setRenderingState(isRendering) {
    renderBtn.disabled = isRendering;
    renderBtn.textContent = isRendering ? "Rendering‚Ä¶" : "Render Video";
  }

  async function downloadMp4FromResponse(res) {
    const ct = (res.headers.get("content-type") || "").toLowerCase();

    if (!res.ok) {
      const detail = ct.includes("application/json")
        ? JSON.stringify(await res.json().catch(() => null), null, 2)
        : await res.text().catch(() => "");
      throw new Error(`HTTP ${res.status} ${res.statusText}\n${detail}`);
    }

    const blob = await res.blob();
    const a = document.createElement("a");
    const objectUrl = URL.createObjectURL(blob);
    a.href = objectUrl;
    a.download = "video.mp4";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(objectUrl);

    logStatus("‚úÖ Done. Downloaded video.mp4");
  }

  function refreshPreview() {
    try {
      const payload = buildPayload();
      payloadPreviewEl.textContent = JSON.stringify(payload, null, 2);
    } catch (e) {
      payloadPreviewEl.textContent = "Preview error: " + (e && e.message ? e.message : String(e));
    }
  }

  function addSlide(data = {}) {
    const idx = slidesEl.querySelectorAll(".slide").length + 1;
    const wrap = document.createElement("div");
    wrap.className = "slide";

    wrap.innerHTML = `
      <div class="slide-head">
        <div class="pill">Slide ${idx}</div>
        <button class="btn danger" type="button" data-action="remove">Remove</button>
      </div>

      <div class="row">
        <div class="field">
          <label>Image URL (required)</label>
          <input class="imageUrl" type="url" placeholder="https://.../image.jpg" value="${data.imageUrl ? escapeHtml(data.imageUrl) : ""}" />
          <div class="inline-note">
            Must be reachable from the container (public URL or your server can access it).
          </div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Headline (optional)</label>
          <input class="headline" type="text" placeholder="Your headline..." value="${data.headline ? escapeHtml(data.headline) : ""}" />
        </div>
      </div>
    `;

    wrap.querySelector('[data-action="remove"]').addEventListener("click", () => {
      wrap.remove();
      relabelSlides();
      refreshSlideCount();
      refreshPreview();
    });

    wrap.querySelector(".imageUrl").addEventListener("input", refreshPreview);
    wrap.querySelector(".headline").addEventListener("input", refreshPreview);

    slidesEl.appendChild(wrap);
    refreshSlideCount();
    refreshPreview();
  }

  el("addSlide").addEventListener("click", () => addSlide());
  el("clearSlides").addEventListener("click", () => {
    slidesEl.innerHTML = "";
    refreshSlideCount();
    refreshPreview();
  });

  el("loadDemo").addEventListener("click", () => {
    slidesEl.innerHTML = "";
    addSlide({ imageUrl: "https://picsum.photos/seed/one/1080/1920", headline: "Slide one headline" });
    addSlide({ imageUrl: "https://picsum.photos/seed/two/1080/1920", headline: "Slide two headline" });
    addSlide({ imageUrl: "https://picsum.photos/seed/three/1080/1920", headline: "Slide three headline" });
    addSlide({ imageUrl: "https://picsum.photos/seed/four/1080/1920", headline: "Slide four headline" });
    refreshSlideCount();
    refreshPreview();
  });

  // Keep preview live for top-level fields
  [
    "apiBase","apiPath","format","style","transition","fps","durationSec","audioVolume",
    "audioUrl","logoUrl","watermarkPos","watermarkOpacity","watermarkSize",
    "introSec","outroSec","outroText","minSlideSec"
  ].forEach(id => {
    const node = el(id);
    if (node) node.addEventListener("input", refreshPreview);
    if (node) node.addEventListener("change", refreshPreview);
  });

  el("renderBtn").addEventListener("click", async () => {
    try {
      setRenderingState(true);

      const apiBase = el("apiBase").value.trim().replace(/\/+$/g, "");
      const apiPath = el("apiPath").value.trim();
      if (!apiBase) throw new Error("API Base URL is empty.");
      if (!apiPath) throw new Error("Render endpoint path is empty.");

      const payload = buildPayload();
      validatePayload(payload);

      const url = apiBase + (apiPath.startsWith("/") ? apiPath : ("/" + apiPath));

      logStatus("üì° POST " + url + "\nRendering‚Ä¶");

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      await downloadMp4FromResponse(res);

    } catch (err) {
      logStatus("‚ùå " + (err && err.message ? err.message : String(err)));
    } finally {
      setRenderingState(false);
    }
  });

  // init
  syncBrandFields();
  el("loadDemo").click();
</script>
</body>
</html>

