<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Video Renderer — Control Room</title>
  <style>
    :root{
      --card-bg: rgba(10, 18, 32, 0.70);
      --card-border: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --accent: rgba(99, 179, 237, 0.95);
      --danger: rgba(248, 113, 113, 0.95);
      --ok: rgba(74, 222, 128, 0.95);
      --shadow: 0 20px 60px rgba(0,0,0,0.35);
      --radius: 18px;
      --gap: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background:
        linear-gradient(180deg, rgba(7,12,22,0.55), rgba(7,12,22,0.75)),
        url("background.png") center/cover no-repeat fixed;
      overflow-x: hidden;
    }

    .wrap {
      max-width: 1120px;
      margin: 0 auto;
      padding: 32px 18px 60px;
    }

    header {
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 16px;
      margin-bottom: 18px;
    }

    h1 {
      margin: 0;
      font-size: clamp(22px, 3vw, 34px);
      letter-spacing: 0.4px;
    }

    .sub {
      margin: 6px 0 0;
      color: var(--muted);
      max-width: 64ch;
      line-height: 1.35;
      font-size: 14px;
    }

    .grid {
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 16px;
      align-items:start;
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
      header { align-items: flex-start; flex-direction: column; }
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 16px;
    }

    .row {
      display:flex;
      gap: var(--gap);
      flex-wrap: wrap;
    }

    label {
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input[type="text"], input[type="number"], input[type="url"], select, textarea {
      width: 100%;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 10px;
      outline: none;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="url"]:focus,
    select:focus,
    textarea:focus {
      border-color: rgba(99,179,237,0.65);
      box-shadow: 0 0 0 3px rgba(99,179,237,0.18);
    }

    input[type="file"]{
      width: 100%;
      color: var(--muted);
    }

    .field { flex: 1; min-width: 220px; }
    .field.small { min-width: 160px; flex: 0.6; }
    .field.tiny  { min-width: 120px; flex: 0.4; }

    .slides {
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 12px;
    }

    .slide {
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      padding: 10px;
      background: rgba(255,255,255,0.05);
    }

    .slide-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .pill {
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 5px 10px;
      border-radius: 999px;
    }

    .btn {
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      user-select: none;
      font-weight: 600;
    }

    .btn:hover { background: rgba(255,255,255,0.12); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .btn.primary {
      background: rgba(99,179,237,0.22);
      border-color: rgba(99,179,237,0.45);
    }

    .btn.danger {
      background: rgba(248,113,113,0.16);
      border-color: rgba(248,113,113,0.45);
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .status {
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,0.78);
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 10px;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 120px;
    }

    .divider {
      height: 1px;
      background: rgba(255,255,255,0.10);
      margin: 14px 0;
    }

    .drop {
      border: 1px dashed rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.04);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      gap: 10px;
      transition: border-color .15s ease, background .15s ease, transform .05s ease;
    }

    .drop:hover {
      border-color: rgba(99,179,237,0.55);
      background: rgba(99,179,237,0.08);
    }

    .drop.dragover {
      border-color: rgba(74,222,128,0.75);
      background: rgba(74,222,128,0.10);
      transform: translateY(-1px);
    }

    .drop-top {
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .drop-title { font-weight: 700; font-size: 13px; }
    .drop-hint { color: var(--muted); font-size: 12px; line-height: 1.35; }
    .drop-actions { display:flex; gap: 10px; align-items:center; }
    .drop input[type="file"] { display: none; }

    .drop-preview {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,0.70);
      font-size: 12px;
    }

    .drop-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }

    .url-fallback { display:grid; gap: 6px; }
    .tiny-note { font-size: 12px; color: rgba(255,255,255,0.65); }

    /* Toggle rows */
    .toggle-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      border-radius: 14px;
      padding: 10px 12px;
      flex: 1;
      min-width: 220px;
    }
    .toggle-left { display:flex; flex-direction:column; gap: 2px; }
    .toggle-title { font-weight: 700; font-size: 13px; }
    .toggle-sub { font-size: 12px; color: rgba(255,255,255,0.70); line-height: 1.25; }

    .switch {
      position: relative;
      width: 46px;
      height: 28px;
      border-radius: 999px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.14);
      flex: 0 0 auto;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease;
    }
    .switch[data-on="true"] {
      background: rgba(74,222,128,0.22);
      border-color: rgba(74,222,128,0.40);
    }
    .knob {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(255,255,255,0.88);
      transition: transform .15s ease;
    }
    .switch[data-on="true"] .knob { transform: translateX(18px); }

    .inline-note {
      font-size: 12px;
      color: rgba(255,255,255,0.68);
      margin-top: 6px;
      line-height: 1.3;
    }

    .brand-adv {
      display:grid;
      gap: 10px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.10);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Video Renderer — Control Room</h1>
        <p class="sub">Upload 4–25 images (+ optional headlines), optionally upload an MP3, and render an MP4 from your API.</p>
      </div>
      <div class="pill">v3 UI (fixed + branding toggles)</div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="row">
          <div class="field">
            <label for="apiBase">API Base URL</label>
            <input id="apiBase" type="url" value="http://localhost:8000" />
            <div class="hint" style="margin-top:6px;">Local: <span class="pill">http://localhost:8000</span> • Deployed: your domain.</div>
          </div>

          <div class="field">
            <label for="n8nWebhook">Media Upload Webhook (n8n)</label>
            <input id="n8nWebhook" type="url" value="https://erasmus-consulting.app.n8n.cloud/webhook/video-render" />
            <div class="hint" style="margin-top:6px;">
              STEP 1: local image files (and MP3 if selected) are uploaded here first. n8n should return the MP4.
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="field small">
            <label for="format">Format</label>
            <select id="format">
              <option value="reel">reel (1080×1920)</option>
              <option value="square">square (1080×1080)</option>
              <option value="linkedin">linkedin (1080×1350)</option>
            </select>
          </div>

          <div class="field small">
            <label for="style">Style</label>
            <select id="style">
              <option value="dark_lab">dark_lab</option>
              <option value="clean_medical">clean_medical</option>
              <option value="energetic">energetic</option>
            </select>
          </div>

          <div class="field small">
            <label for="transition">Transition</label>
            <select id="transition">
              <option value="fade">fade</option>
              <option value="wipeleft">wipeleft</option>
              <option value="wiperight">wiperight</option>
              <option value="slideleft">slideleft</option>
              <option value="slideright">slideright</option>
            </select>
          </div>

          <div class="field tiny">
            <label for="fps">FPS</label>
            <input id="fps" type="number" min="1" max="60" value="30" />
          </div>

          <div class="field tiny">
            <label for="durationSec">Duration (sec)</label>
            <input id="durationSec" type="number" min="2" value="12" />
          </div>

          <div class="field tiny">
            <label for="audioVolume">Audio Volume (0..1)</label>
            <input id="audioVolume" type="number" min="0" max="1" step="0.01" value="0.50" />
          </div>
        </div>

        <div class="divider"></div>

        <!-- Branding toggles -->
        <div class="row">
          <div class="toggle-row">
            <div class="toggle-left">
              <div class="toggle-title">Watermark (logo)</div>
              <div class="toggle-sub">Bottom-right logo overlay on slides</div>
            </div>
            <div id="toggleWatermark" class="switch" data-on="true" role="switch" aria-checked="true" tabindex="0">
              <div class="knob"></div>
            </div>
          </div>

          <div class="toggle-row">
            <div class="toggle-left">
              <div class="toggle-title">Frame overlay</div>
              <div class="toggle-sub">Transparent PNG frame on top of video</div>
            </div>
            <div id="toggleFrame" class="switch" data-on="true" role="switch" aria-checked="true" tabindex="0">
              <div class="knob"></div>
            </div>
          </div>
        </div>

        <div class="brand-adv">
          <div class="row">
            <div class="field">
              <label for="logoUrl">Logo URL (optional)</label>
              <input id="logoUrl" type="url" placeholder="https://.../logo.png" />
              <div class="inline-note">
                If empty: API may use bundled <span class="pill">/app/assets/logo.png</span> (if present).  
                If Watermark is OFF, the logo will not be used for watermark.
              </div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="framePath">Frame path (optional)</label>
              <input id="framePath" type="text" value="assets/frame_overlay.png" />
              <div class="inline-note">
                Default: <span class="pill">assets/frame_overlay.png</span> (inside your container at <span class="pill">/app/assets/</span>).
              </div>
            </div>

            <div class="field small">
              <label for="frameOpacity">Frame opacity (0..1)</label>
              <input id="frameOpacity" type="number" min="0" max="1" step="0.01" value="1.00" />
            </div>

            <div class="field small">
              <label for="frameScaleMode">Frame scale mode</label>
              <select id="frameScaleMode">
                <option value="stretch">stretch</option>
                <option value="fit">fit</option>
              </select>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="field">
            <label for="audioMp3">Audio (MP3 upload — optional)</label>
            <input id="audioMp3" type="file" accept="audio/mpeg,audio/mp3,audio/*" />
            <div class="hint" style="margin-top:6px;">
              If MP3 selected: it will be uploaded to n8n as form field <span class="pill">audio</span>.
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between; align-items:center;">
          <div class="hint">Slides: <span id="slideCount" class="pill">0</span> (must be 4–25)</div>
          <div class="row">
            <button id="addSlide" class="btn" type="button">+ Add Slide</button>
            <button id="loadDemo" class="btn" type="button">Load Demo (4)</button>
            <button id="clearSlides" class="btn danger" type="button">Clear</button>
          </div>
        </div>

        <div class="slides" id="slides"></div>

        <div class="divider"></div>

        <div class="row">
          <button id="renderBtn" class="btn primary" type="button" style="flex:1;">Render Video</button>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h3 style="margin:0 0 8px;">Status</h3>
        <div id="status" class="status">Ready.</div>

        <div class="divider"></div>

        <h3 style="margin:0 0 8px;">Quick rules</h3>
        <div class="hint">
          <ul style="margin:0; padding-left:18px; line-height:1.4;">
            <li>Slides must be <b>4–25</b></li>
            <li>Each slide needs a <b>file</b> or <b>URL</b></li>
            <li>If any slide uses a <b>file</b> → upload files to n8n to render</li>
            <li>If MP3 selected → upload it to n8n as <b>audio</b></li>
            <li>Branding toggles are sent as real booleans (<span class="pill">true/false</span>)</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

<script>
  "use strict";

  const el = (id) => document.getElementById(id);

  const slidesEl = el("slides");
  const slideCountEl = el("slideCount");
  const statusEl = el("status");
  const renderBtn = el("renderBtn");
  const audioMp3El = el("audioMp3");

  const toggleWatermarkEl = el("toggleWatermark");
  const toggleFrameEl = el("toggleFrame");

  function logStatus(msg) { statusEl.textContent = msg; }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll("\"","&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------- Switch helpers ----------
  function isSwitchOn(swEl) {
    return String(swEl.getAttribute("data-on")) === "true";
  }
  function setSwitch(swEl, on) {
    const v = !!on;
    swEl.setAttribute("data-on", v ? "true" : "false");
    swEl.setAttribute("aria-checked", v ? "true" : "false");
  }
  function toggleSwitch(swEl) {
    setSwitch(swEl, !isSwitchOn(swEl));
  }
  function wireSwitch(swEl, onChange) {
    swEl.addEventListener("click", () => { toggleSwitch(swEl); onChange && onChange(isSwitchOn(swEl)); });
    swEl.addEventListener("keydown", (e) => {
      if (e.key === " " || e.key === "Enter") {
        e.preventDefault();
        toggleSwitch(swEl);
        onChange && onChange(isSwitchOn(swEl));
      }
    });
  }

  setSwitch(toggleWatermarkEl, true);
  setSwitch(toggleFrameEl, true);

  function syncFrameFields() {
    const on = isSwitchOn(toggleFrameEl);
    el("framePath").disabled = !on;
    el("frameOpacity").disabled = !on;
    el("frameScaleMode").disabled = !on;
  }
  wireSwitch(toggleFrameEl, syncFrameFields);
  wireSwitch(toggleWatermarkEl, () => {});
  syncFrameFields();

  function cleanupSlidePreview(slideEl) {
    if (slideEl && slideEl._previewObjectUrl) {
      try { URL.revokeObjectURL(slideEl._previewObjectUrl); } catch {}
      slideEl._previewObjectUrl = null;
    }
  }

  function applySlideFile(slideEl, file, previewEl, clearBtn) {
    cleanupSlidePreview(slideEl);
    slideEl._imageFile = file;
    clearBtn.style.display = "inline-block";

    const url = URL.createObjectURL(file);
    slideEl._previewObjectUrl = url;
    previewEl.innerHTML = `<img src="${url}" alt="preview" />`;
  }

  function currentSlides() {
    const nodes = slidesEl.querySelectorAll(".slide");
    return [...nodes].map((node) => {
      const headline = node.querySelector(".headline").value.trim();
      const file = node._imageFile || null;
      const imageUrl = node.querySelector(".imageUrl").value.trim();
      return { imageUrl: imageUrl || "", headline: headline || null, file };
    });
  }

  function refreshSlideCount() {
    slideCountEl.textContent = String(slidesEl.querySelectorAll(".slide").length);
  }

  function relabelSlides() {
    [...slidesEl.querySelectorAll(".slide")].forEach((s, i) => {
      const pill = s.querySelector(".pill");
      if (pill) pill.textContent = `Slide ${i + 1}`;
    });
  }

  function buildUiState() {
    const watermarkEnabled = isSwitchOn(toggleWatermarkEl);
    const frameEnabled = isSwitchOn(toggleFrameEl);

    const logoUrl = el("logoUrl").value.trim();
    const framePath = el("framePath").value.trim();
    const frameOpacity = Number(el("frameOpacity").value);
    const frameScaleMode = el("frameScaleMode").value;

    return {
      format: el("format").value,
      style: el("style").value,
      transition: el("transition").value,
      durationSec: Number(el("durationSec").value),
      slides: currentSlides(),
      output: { fps: Number(el("fps").value) },
      audioVolume: Number(el("audioVolume").value),

      watermarkEnabled,
      frameEnabled,

      brand: {
        enabled: true,
        watermarkEnabled,
        frameEnabled,
        ...(watermarkEnabled ? { logoUrl: (logoUrl || undefined) } : {}),
        ...(frameEnabled ? {
          framePath: (framePath || undefined),
          frameOpacity: Number.isFinite(frameOpacity) ? frameOpacity : undefined,
          frameScaleMode: frameScaleMode || undefined
        } : {})
      }
    };
  }

  function validateBeforeSend(uiState) {
    if (!Array.isArray(uiState.slides) || uiState.slides.length < 4 || uiState.slides.length > 25) {
      throw new Error(`Slides must be 4–25. You have ${uiState.slides?.length ?? 0}.`);
    }
    for (let i = 0; i < uiState.slides.length; i++) {
      const hasUrl = (uiState.slides[i].imageUrl || "").trim().length > 0;
      const hasFile = !!uiState.slides[i].file;
      if (!hasUrl && !hasFile) throw new Error(`Slide ${i+1} needs an image (file or URL).`);
    }
    if (!Number.isFinite(uiState.durationSec) || uiState.durationSec < 2) throw new Error("Duration must be at least 2 seconds.");
    if (!Number.isFinite(uiState.output?.fps) || uiState.output.fps < 1 || uiState.output.fps > 60) throw new Error("FPS must be 1–60.");
    if (!Number.isFinite(uiState.audioVolume) || uiState.audioVolume < 0 || uiState.audioVolume > 1) throw new Error("Audio volume must be 0..1.");

    if (uiState.frameEnabled) {
      const op = uiState.brand?.frameOpacity;
      if (op !== undefined && (!Number.isFinite(op) || op < 0 || op > 1)) {
        throw new Error("Frame opacity must be 0..1.");
      }
    }
  }

  function setRenderingState(isRendering) {
    renderBtn.disabled = isRendering;
    renderBtn.textContent = isRendering ? "Rendering…" : "Render Video";
  }

  async function downloadMp4FromResponse(res) {
    const ct = (res.headers.get("content-type") || "").toLowerCase();

    if (!res.ok) {
      // try to show useful error text/json
      const detail = ct.includes("application/json")
        ? JSON.stringify(await res.json().catch(() => null), null, 2)
        : await res.text().catch(() => "");
      throw new Error(`HTTP ${res.status} ${res.statusText}\n${detail}`);
    }

    const blob = await res.blob();
    const a = document.createElement("a");
    const objectUrl = URL.createObjectURL(blob);
    a.href = objectUrl;
    a.download = "video.mp4";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(objectUrl);

    logStatus("✅ Done. Downloaded video.mp4");
  }

  function addSlide(data = {}) {
    const idx = slidesEl.querySelectorAll(".slide").length + 1;
    const wrap = document.createElement("div");
    wrap.className = "slide";
    wrap._imageFile = null;
    wrap._previewObjectUrl = null;

    wrap.innerHTML = `
      <div class="slide-head">
        <div class="pill">Slide ${idx}</div>
        <button class="btn danger" type="button" data-action="remove">Remove</button>
      </div>

      <div class="row">
        <div class="field">
          <label>Image</label>

          <div class="drop">
            <div class="drop-top">
              <div>
                <div class="drop-title">Drag & drop an image here</div>
                <div class="drop-hint">PNG/JPG/WebP • or choose a file</div>
              </div>

              <div class="drop-actions">
                <button class="btn" type="button" data-action="choose">Choose file</button>
                <button class="btn danger" type="button" data-action="clear" style="display:none;">Clear</button>
              </div>

              <input class="imageFile" type="file" accept="image/*" />
            </div>

            <div class="drop-preview">
              <span>No image selected</span>
            </div>

            <div class="url-fallback">
              <div class="tiny-note">Optional: paste an Image URL instead</div>
              <input class="imageUrl" type="url" placeholder="https://..." value="${data.imageUrl ? escapeHtml(data.imageUrl) : ""}" />
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Headline (optional)</label>
          <input class="headline" type="text" placeholder="Your headline..." value="${data.headline ? escapeHtml(data.headline) : ""}" />
        </div>
      </div>
    `;

    wrap.querySelector('[data-action="remove"]').addEventListener("click", () => {
      cleanupSlidePreview(wrap);
      wrap.remove();
      relabelSlides();
      refreshSlideCount();
    });

    const drop = wrap.querySelector(".drop");
    const fileInput = wrap.querySelector(".imageFile");
    const chooseBtn = wrap.querySelector('[data-action="choose"]');
    const clearBtn = wrap.querySelector('[data-action="clear"]');
    const preview = wrap.querySelector(".drop-preview");
    const urlInput = wrap.querySelector(".imageUrl");

    chooseBtn.addEventListener("click", () => fileInput.click());

    clearBtn.addEventListener("click", () => {
      cleanupSlidePreview(wrap);
      wrap._imageFile = null;
      fileInput.value = "";
      clearBtn.style.display = "none";
      preview.innerHTML = `<span>No image selected</span>`;
    });

    urlInput.addEventListener("input", () => {
      if (!wrap._imageFile && urlInput.value.trim()) preview.innerHTML = `<span>Using image URL</span>`;
      if (!wrap._imageFile && !urlInput.value.trim()) preview.innerHTML = `<span>No image selected</span>`;
    });

    fileInput.addEventListener("change", () => {
      const f = fileInput.files && fileInput.files[0];
      if (!f) return;
      if (!f.type.startsWith("image/")) { logStatus("❌ Selected file is not an image."); return; }
      applySlideFile(wrap, f, preview, clearBtn);
    });

    ["dragenter", "dragover"].forEach(evt =>
      drop.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        drop.classList.add("dragover");
      })
    );
    ["dragleave", "drop"].forEach(evt =>
      drop.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        drop.classList.remove("dragover");
      })
    );

    drop.addEventListener("drop", (e) => {
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if (!f) return;
      if (!f.type.startsWith("image/")) { logStatus("❌ Dropped file is not an image."); return; }
      applySlideFile(wrap, f, preview, clearBtn);
    });

    slidesEl.appendChild(wrap);
    refreshSlideCount();
  }

  el("addSlide").addEventListener("click", () => addSlide());
  el("clearSlides").addEventListener("click", () => {
    [...slidesEl.querySelectorAll(".slide")].forEach(s => cleanupSlidePreview(s));
    slidesEl.innerHTML = "";
    refreshSlideCount();
  });
  el("loadDemo").addEventListener("click", () => {
    [...slidesEl.querySelectorAll(".slide")].forEach(s => cleanupSlidePreview(s));
    slidesEl.innerHTML = "";
    addSlide({ imageUrl: "https://picsum.photos/seed/one/1080/1920", headline: "Slide one headline" });
    addSlide({ imageUrl: "https://picsum.photos/seed/two/1080/1920", headline: "Slide two headline" });
    addSlide({ imageUrl: "https://picsum.photos/seed/three/1080/1920", headline: "Slide three headline" });
    addSlide({ imageUrl: "https://picsum.photos/seed/four/1080/1920", headline: "Slide four headline" });
    refreshSlideCount();
  });

  // ✅ PATCHED: ONE-SHOT upload+render via n8n, and upload images as file0..fileN
  el("renderBtn").addEventListener("click", async () => {
    try {
      setRenderingState(true);

      const webhook = el("n8nWebhook").value.trim();
      if (!webhook) throw new Error("Media Upload Webhook (n8n) is empty.");

      const ui = buildUiState();
      validateBeforeSend(ui);

      const mp3 = audioMp3El.files && audioMp3El.files[0];

      const fd = new FormData();

      // ✅ CRITICAL FIX: unique keys so n8n receives ALL files
      let fileCount = 0;
      ui.slides.forEach((s, i) => {
        if (s.file) {
          const safeName = s.file.name || `slide_${String(i + 1).padStart(2, "0")}.png`;
          fd.append(`file${fileCount}`, s.file, safeName);
          fileCount++;
        }
      });

      // Optional audio
      if (mp3) fd.append("audio", mp3, mp3.name || "audio.mp3");

      // Payload (so watermark/frame toggles travel through n8n)
      fd.append("payload", JSON.stringify({
        format: ui.format,
        style: ui.style,
        transition: ui.transition,
        durationSec: ui.durationSec,
        audioVolume: ui.audioVolume,
        watermarkEnabled: ui.watermarkEnabled,
        frameEnabled: ui.frameEnabled,
        brand: ui.brand,
        slides: ui.slides.map(s => ({ headline: s.headline || undefined }))
      }));

      fd.append("meta", JSON.stringify({
        totalSlides: ui.slides.length,
        uploadedImages: fileCount,
        hasAudio: !!mp3,
      }));

      logStatus(`⬆️ Uploading ${fileCount} image(s) ${mp3 ? "+ audio " : ""}to n8n and rendering…`);

      const res = await fetch(webhook, { method: "POST", body: fd });
      await downloadMp4FromResponse(res);

    } catch (err) {
      logStatus("❌ " + (err && err.message ? err.message : String(err)));
    } finally {
      setRenderingState(false);
    }
  });

  el("loadDemo").click();
</script>
</body>
</html>
