<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Video Renderer — Control Room</title>
  <style>
    :root{
      --card-bg: rgba(10, 18, 32, 0.70);
      --card-border: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --accent: rgba(99, 179, 237, 0.95);
      --danger: rgba(248, 113, 113, 0.95);
      --ok: rgba(74, 222, 128, 0.95);
      --shadow: 0 20px 60px rgba(0,0,0,0.35);
      --radius: 18px;
      --gap: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background:
        linear-gradient(180deg, rgba(7,12,22,0.55), rgba(7,12,22,0.75)),
        url("background.png") center/cover no-repeat fixed;
      overflow-x: hidden;
    }

    .wrap {
      max-width: 1120px;
      margin: 0 auto;
      padding: 32px 18px 60px;
    }

    header {
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 16px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-size: clamp(22px, 3vw, 34px);
      letter-spacing: 0.4px;
    }

    .sub {
      margin: 6px 0 0;
      color: var(--muted);
      max-width: 70ch;
      line-height: 1.35;
      font-size: 14px;
    }

    .grid {
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 16px;
      align-items:start;
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
      header { align-items: flex-start; }
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 16px;
    }

    label {
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input[type="number"], input[type="url"], select {
      width: 100%;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 10px;
      outline: none;
    }

    input[type="number"]:focus, input[type="url"]:focus, select:focus {
      border-color: rgba(99,179,237,0.65);
      box-shadow: 0 0 0 3px rgba(99,179,237,0.18);
    }

    .row {
      display:flex;
      gap: var(--gap);
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .field { flex: 1; min-width: 220px; }
    .field.small { min-width: 160px; flex: 0.6; }
    .field.tiny  { min-width: 120px; flex: 0.4; }

    .divider {
      height: 1px;
      background: rgba(255,255,255,0.10);
      margin: 14px 0;
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .status {
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,0.78);
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 10px;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 160px;
    }

    .pill {
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 5px 10px;
      border-radius: 999px;
    }

    .btn {
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      user-select: none;
      font-weight: 600;
    }

    .btn:hover { background: rgba(255,255,255,0.12); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .btn.primary {
      background: rgba(99,179,237,0.22);
      border-color: rgba(99,179,237,0.45);
    }

    .btn.danger {
      background: rgba(248,113,113,0.16);
      border-color: rgba(248,113,113,0.45);
    }

    .btn.small {
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 10px;
    }

    .drop {
      border: 1px dashed rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.04);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      gap: 10px;
      transition: border-color .15s ease, background .15s ease, transform .05s ease;
    }

    .drop:hover {
      border-color: rgba(99,179,237,0.55);
      background: rgba(99,179,237,0.08);
    }

    .drop.dragover {
      border-color: rgba(74,222,128,0.75);
      background: rgba(74,222,128,0.10);
      transform: translateY(-1px);
    }

    .drop-top {
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .drop-title { font-weight: 700; font-size: 13px; }
    .drop-hint { color: var(--muted); font-size: 12px; line-height: 1.35; }

    .drop-actions { display:flex; gap: 10px; align-items:center; }
    .drop input[type="file"] { display: none; }

    .drop-preview {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,0.70);
      font-size: 12px;
    }

    .drop-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }

    .tiny-note { font-size: 12px; color: rgba(255,255,255,0.65); line-height: 1.3; }
    .section-title { margin: 0 0 8px; font-size: 14px; letter-spacing: 0.2px; }

    .slides-topbar{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .slides-count{
      color: rgba(255,255,255,0.80);
      font-size: 12px;
      font-family: var(--mono);
    }

    .slide-box{
      flex: 1;
      min-width: 240px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Video Renderer — Control Room</h1>
        <p class="sub">
          Add <b>4–25</b> slide images, optionally add an MP3, optionally add a logo.
          We send the files to n8n; n8n forwards them to your API.
        </p>
      </div>
      <div class="pill">Slides 4–25</div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">

        <div class="row">
          <div class="field">
            <label for="n8nWebhook">n8n Webhook</label>
            <input id="n8nWebhook" type="url" value="https://n8n.erasmuslabs.pl/webhook/video-render" />
            <div class="hint" style="margin-top:6px;">
              Must accept <span class="pill">multipart/form-data</span> and return <span class="pill">video/mp4</span>.
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="field small">
            <label for="format">Format</label>
            <select id="format">
              <option value="reel">reel (1080×1920)</option>
              <option value="square">square (1080×1080)</option>
              <option value="linkedin">linkedin (1080×1350)</option>
            </select>
          </div>

          <div class="field small">
            <label for="style">Style</label>
            <select id="style">
              <option value="dark_lab">dark_lab</option>
              <option value="clean_medical">clean_medical</option>
              <option value="energetic">energetic</option>
            </select>
          </div>

          <div class="field small">
            <label for="transition">Transition</label>
            <select id="transition">
              <option value="fade">fade</option>
              <option value="wipeleft">wipeleft</option>
              <option value="wiperight">wiperight</option>
              <option value="slideleft">slideleft</option>
              <option value="slideright">slideright</option>
            </select>
          </div>

          <div class="field tiny">
            <label for="fps">FPS</label>
            <input id="fps" type="number" min="1" max="60" value="30" />
          </div>

          <div class="field tiny">
            <label for="durationSec">Duration (sec)</label>
            <input id="durationSec" type="number" min="2" value="12" />
          </div>

          <div class="field tiny">
            <label for="audioVolume">Audio volume (0..3)</label>
            <input id="audioVolume" type="number" min="0" max="3" step="0.01" value="0.50" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="slides-topbar">
          <div>
            <h3 class="section-title" style="margin:0;">1) Slides (required — 4 to 25)</h3>
            <div class="slides-count" id="slidesCount">0 / 25</div>
          </div>
          <div class="drop-actions">
            <button id="addSlideBtn" class="btn small" type="button">+ Add slide</button>
            <button id="removeSlideBtn" class="btn small danger" type="button">− Remove last</button>
          </div>
        </div>

        <div id="slides" class="row"></div>

        <div class="divider"></div>

        <h3 class="section-title">2) Audio (optional)</h3>
        <div class="row">
          <div class="field">
            <label for="audioMp3">MP3 file</label>
            <input id="audioMp3" type="file" accept="audio/mpeg,audio/mp3,audio/*" />
            <div class="tiny-note" style="margin-top:6px;">
              Sent to n8n as field <span class="pill">audio</span>.
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <h3 class="section-title">3) Logo (optional)</h3>
        <div class="row">
          <div class="field">
            <label>Logo upload</label>
            <div id="logoDrop" class="drop">
              <div class="drop-top">
                <div>
                  <div class="drop-title">Drag & drop logo here</div>
                  <div class="drop-hint">PNG recommended (transparent looks best)</div>
                </div>
                <div class="drop-actions">
                  <button id="chooseLogoBtn" class="btn" type="button">Choose logo</button>
                  <button id="clearLogoBtn" class="btn danger" type="button" style="display:none;">Clear</button>
                </div>
                <input id="logoFile" type="file" accept="image/*" />
              </div>
              <div id="logoPreview" class="drop-preview"><span>No logo selected</span></div>
              <div class="tiny-note">
                Sent to n8n as field <span class="pill">logo</span>. n8n forwards as multipart and the API injects <span class="pill">brand.logoUrl</span>.
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button id="renderBtn" class="btn primary" type="button" style="flex:1;">Render Video</button>
          <button id="clearAllBtn" class="btn danger" type="button">Clear all</button>
        </div>

      </div>

      <!-- RIGHT -->
      <div class="card">
        <h3 style="margin:0 0 8px;">Status</h3>
        <div id="status" class="status">Ready.</div>

        <div class="divider"></div>

        <div class="hint">
          <div style="margin-bottom:8px;"><b>Uploads to n8n:</b></div>
          <ul style="margin:0; padding-left:18px; line-height:1.4;">
            <li><span class="pill">files</span> (repeated, required: 4–25)</li>
            <li><span class="pill">audio</span> (optional)</li>
            <li><span class="pill">logo</span> (optional)</li>
            <li><span class="pill">payload</span> (JSON)</li>
          </ul>
          <div class="tiny-note" style="margin-top:8px;">
            Note: Your n8n workflow must accept <span class="pill">files</span> and forward to your API endpoint that supports it (recommended: <span class="pill">/render-multipart</span>).
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
"use strict";

function el(id){ return document.getElementById(id); }

const statusEl = el("status");
const slidesWrap = el("slides");
const renderBtn = el("renderBtn");
const clearAllBtn = el("clearAllBtn");

const audioMp3El = el("audioMp3");

const logoDropEl = el("logoDrop");
const logoFileEl = el("logoFile");
const logoPreviewEl = el("logoPreview");
const chooseLogoBtn = el("chooseLogoBtn");
const clearLogoBtn = el("clearLogoBtn");

const addSlideBtn = el("addSlideBtn");
const removeSlideBtn = el("removeSlideBtn");
const slidesCountEl = el("slidesCount");

const MIN_SLIDES = 4;
const MAX_SLIDES = 25;

function logStatus(msg){ statusEl.textContent = msg; }

function setRenderingState(on){
  renderBtn.disabled = on;
  renderBtn.textContent = on ? "Rendering…" : "Render Video";
  addSlideBtn.disabled = on;
  removeSlideBtn.disabled = on;
  clearAllBtn.disabled = on;
}

function revokeObjectUrl(url){
  if (!url) return;
  try { URL.revokeObjectURL(url); } catch {}
}

/* ---------------- Slides (4..25) ----------------
   IMPORTANT FIX:
   - We NEVER rebuild the entire slides UI on add/remove.
   - We append/remove DOM nodes to keep existing file inputs intact.
   - This prevents losing already-selected files.
-------------------------------------------------- */

const slidesState = [];

function updateSlidesCount(){
  slidesCountEl.textContent = `${slidesState.length} / ${MAX_SLIDES}`;
}

function createSlideElement(index){
  const box = document.createElement("div");
  box.className = "slide-box";
  box.dataset.slideIndex = String(index);

  box.innerHTML = `
    <label>Slide ${index + 1} (required)</label>
    <div class="drop" id="drop_${index}">
      <div class="drop-top">
        <div>
          <div class="drop-title">Drag & drop image here</div>
          <div class="drop-hint">PNG/JPG/WebP</div>
        </div>
        <div class="drop-actions">
          <button class="btn" type="button" id="choose_${index}">Choose</button>
          <button class="btn danger" type="button" id="clear_${index}" style="display:none;">Clear</button>
        </div>
        <input type="file" id="file_${index}" accept="image/*" />
      </div>
      <div class="drop-preview" id="preview_${index}">
        <span>No image selected</span>
      </div>
      <div class="tiny-note">
        Sent to n8n as <span class="pill">files</span> (repeated field).
      </div>
    </div>
  `;

  // Wire events for this one slide (no global rerender)
  const drop = box.querySelector(`#drop_${index}`);
  const fileInput = box.querySelector(`#file_${index}`);
  const chooseBtn = box.querySelector(`#choose_${index}`);
  const clearBtn = box.querySelector(`#clear_${index}`);
  const preview = box.querySelector(`#preview_${index}`);

  function setPreview(file){
    if (!file || !file.type || !file.type.startsWith("image/")) {
      throw new Error("Slide file must be an image.");
    }

    // cleanup previous preview
    revokeObjectUrl(slidesState[index].previewUrl);

    slidesState[index].file = file;
    slidesState[index].previewUrl = URL.createObjectURL(file);

    preview.innerHTML = `<img src="${slidesState[index].previewUrl}" alt="slide preview" />`;
    clearBtn.style.display = "inline-block";
  }

  function clearThis(){
    revokeObjectUrl(slidesState[index].previewUrl);
    slidesState[index].file = null;
    slidesState[index].previewUrl = null;
    if (fileInput) fileInput.value = "";
    preview.innerHTML = `<span>No image selected</span>`;
    clearBtn.style.display = "none";
  }

  chooseBtn.addEventListener("click", () => fileInput.click());
  clearBtn.addEventListener("click", clearThis);

  fileInput.addEventListener("change", () => {
    const f = fileInput.files && fileInput.files[0];
    if (!f) return;
    try { setPreview(f); }
    catch(err){ logStatus("❌ " + (err.message || String(err))); }
  });

  ["dragenter","dragover"].forEach(evt => {
    drop.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      drop.classList.add("dragover");
    });
  });

  ["dragleave","drop"].forEach(evt => {
    drop.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      drop.classList.remove("dragover");
    });
  });

  drop.addEventListener("drop", (e) => {
    const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    if (!f) return;
    try { setPreview(f); }
    catch(err){ logStatus("❌ " + (err.message || String(err))); }
  });

  return box;
}

function renumberSlideLabels(){
  // After removing, we renumber labels only (no rerender, no input destruction)
  const children = slidesWrap.querySelectorAll(".slide-box");
  children.forEach((box, idx) => {
    const label = box.querySelector("label");
    if (label) label.textContent = `Slide ${idx + 1} (required)`;
  });
}

function addSlide(){
  if (slidesState.length >= MAX_SLIDES) {
    logStatus(`❌ Max slides reached (${MAX_SLIDES}).`);
    return;
  }

  const index = slidesState.length;
  slidesState.push({ file: null, previewUrl: null });

  const node = createSlideElement(index);
  slidesWrap.appendChild(node);

  updateSlidesCount();
  renumberSlideLabels();
}

function removeLastSlide(){
  if (slidesState.length <= MIN_SLIDES) {
    logStatus(`❌ You must keep at least ${MIN_SLIDES} slides.`);
    return;
  }

  const lastIndex = slidesState.length - 1;
  const lastState = slidesState[lastIndex];
  if (lastState) revokeObjectUrl(lastState.previewUrl);

  slidesState.pop();

  // Remove the last DOM node
  const lastBox = slidesWrap.querySelector(`.slide-box[data-slide-index="${lastIndex}"]`);
  if (lastBox && lastBox.parentNode) lastBox.parentNode.removeChild(lastBox);

  updateSlidesCount();
  renumberSlideLabels();
}

function clearAllSlides(){
  // cleanup previews
  slidesState.forEach(s => revokeObjectUrl(s.previewUrl));

  // reset state
  slidesState.length = 0;

  // remove DOM nodes
  slidesWrap.innerHTML = "";

  // rebuild ONLY ONCE for full reset
  for (let i = 0; i < MIN_SLIDES; i++){
    slidesState.push({ file: null, previewUrl: null });
    const node = createSlideElement(i);
    slidesWrap.appendChild(node);
  }

  updateSlidesCount();
  renumberSlideLabels();
}

addSlideBtn.addEventListener("click", addSlide);
removeSlideBtn.addEventListener("click", removeLastSlide);

/* ---------------- Logo (optional) ---------------- */

const logoState = { file: null, previewUrl: null };

function setLogoFile(file){
  if (!file || !file.type || !file.type.startsWith("image/")) {
    throw new Error("Logo file must be an image.");
  }
  revokeObjectUrl(logoState.previewUrl);
  logoState.file = file;
  logoState.previewUrl = URL.createObjectURL(file);
  logoPreviewEl.innerHTML = `<img src="${logoState.previewUrl}" alt="logo preview" />`;
  clearLogoBtn.style.display = "inline-block";
}

function clearLogo(){
  revokeObjectUrl(logoState.previewUrl);
  logoState.file = null;
  logoState.previewUrl = null;
  logoFileEl.value = "";
  logoPreviewEl.innerHTML = `<span>No logo selected</span>`;
  clearLogoBtn.style.display = "none";
}

chooseLogoBtn.addEventListener("click", () => logoFileEl.click());
clearLogoBtn.addEventListener("click", clearLogo);

logoFileEl.addEventListener("change", () => {
  const f = logoFileEl.files && logoFileEl.files[0];
  if (!f) return;
  try { setLogoFile(f); }
  catch(err){ logStatus("❌ " + (err.message || String(err))); }
});

["dragenter","dragover"].forEach(evt => {
  logoDropEl.addEventListener(evt, (e) => {
    e.preventDefault(); e.stopPropagation();
    logoDropEl.classList.add("dragover");
  });
});
["dragleave","drop"].forEach(evt => {
  logoDropEl.addEventListener(evt, (e) => {
    e.preventDefault(); e.stopPropagation();
    logoDropEl.classList.remove("dragover");
  });
});
logoDropEl.addEventListener("drop", (e) => {
  const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
  if (!f) return;
  try { setLogoFile(f); }
  catch(err){ logStatus("❌ " + (err.message || String(err))); }
});

/* ---------------- Render ---------------- */

function validate(){
  if (slidesState.length < MIN_SLIDES) throw new Error(`You must have at least ${MIN_SLIDES} slides.`);
  if (slidesState.length > MAX_SLIDES) throw new Error(`You can have at most ${MAX_SLIDES} slides.`);

  for (let i = 0; i < slidesState.length; i++){
    if (!slidesState[i].file) throw new Error(`Slide ${i + 1} is missing an image.`);
  }

  const fps = Number(el("fps").value);
  const durationSec = Number(el("durationSec").value);
  const audioVolume = Number(el("audioVolume").value);

  if (!Number.isFinite(fps) || fps < 1 || fps > 60) throw new Error("FPS must be 1–60.");
  if (!Number.isFinite(durationSec) || durationSec < 2) throw new Error("Duration must be at least 2 seconds.");
  if (!Number.isFinite(audioVolume) || audioVolume < 0 || audioVolume > 3) throw new Error("Audio volume must be 0..3.");
}

async function downloadMp4(res){
  const ct = (res.headers.get("content-type") || "").toLowerCase();
  if (!res.ok){
    const detail = ct.includes("application/json")
      ? JSON.stringify(await res.json().catch(() => null), null, 2)
      : await res.text().catch(() => "");
    throw new Error(`HTTP ${res.status} ${res.statusText}\n${detail}`);
  }
  const blob = await res.blob();
  const a = document.createElement("a");
  const url = URL.createObjectURL(blob);
  a.href = url;
  a.download = "video.mp4";
  document.body.appendChild(a);
  a.click();
  a.remove();
  revokeObjectUrl(url);
}

renderBtn.addEventListener("click", async () => {
  try{
    setRenderingState(true);

    const webhook = el("n8nWebhook").value.trim();
    if (!webhook) throw new Error("n8n Webhook is empty.");

    validate();

    const fps = Number(el("fps").value);
    const durationSec = Number(el("durationSec").value);
    const audioVolume = Number(el("audioVolume").value);

    const fd = new FormData();

    // Slides as repeated "files"
    slidesState.forEach((s, idx) => {
      const fname = (s.file && s.file.name) ? s.file.name : `slide_${idx + 1}.png`;
      fd.append("files", s.file, fname);
    });

    // optional audio
    const mp3 = audioMp3El.files && audioMp3El.files[0];
    if (mp3) fd.append("audio", mp3, mp3.name || "audio.mp3");

    // optional logo
    if (logoState.file) fd.append("logo", logoState.file, logoState.file.name || "logo.png");

    // payload (slides array size must match)
    fd.append("payload", JSON.stringify({
      format: el("format").value,
      style: el("style").value,
      transition: el("transition").value,
      durationSec: durationSec,
      audioVolume: audioVolume,
      output: { fps: fps },
      slides: slidesState.map(() => ({ headline: null })),
      brand: {}
    }));

    logStatus(`⬆️ Uploading ${slidesState.length} slides${logoState.file ? " + logo" : ""}${mp3 ? " + audio" : ""} to n8n and rendering…`);

    const res = await fetch(webhook, { method: "POST", body: fd });
    await downloadMp4(res);

    logStatus("✅ Done. Downloaded video.mp4");
  } catch(err){
    logStatus("❌ " + (err && err.message ? err.message : String(err)));
  } finally {
    setRenderingState(false);
  }
});

clearAllBtn.addEventListener("click", () => {
  clearAllSlides();
  clearLogo();
  if (audioMp3El) audioMp3El.value = "";
  logStatus("Cleared.");
});

/* init */
clearAllSlides();
logStatus("Ready. Add 4–25 images, optional audio/logo, then Render.");
</script>

</body>
</html>
